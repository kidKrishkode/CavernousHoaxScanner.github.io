const fileInput = document.getElementById('file-input');
const preview = document.querySelector('.preview');
const placeholder = document.querySelector('.placeholder');
const dropBox = document.querySelector('.drop-box');

fileInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = () => {
      const dataURL = reader.result;
      preview.innerHTML = '';
      if(file.type.startsWith('image/')){
        const img = document.createElement('img');
        img.src = dataURL;
        preview.appendChild(img);
        Filevalidation(30 * 1024, 5);
      }else if(file.type.startsWith('video/')){
        let video = document.createElement('video');
        video.autoplay = true;
        video.controls = true;
        video.muted = true;
        let source = document.createElement('source');
        source.src = dataURL;
        source.type = 'video/mp4';
        video.appendChild(source);
        preview.appendChild(video);
        displayVinfo(dataURL);
        Filevalidation(60 * 1024, 200);
      }
      placeholder.style.display = 'none';
    };
    reader.readAsDataURL(file);
  }
});

dropBox.addEventListener('dragover', (e) => {
  e.preventDefault();
});

dropBox.addEventListener('drop', (e) => {
  e.preventDefault();
  const file = e.dataTransfer.files[0];
  fileInput.files = e.dataTransfer.files;
  fileInput.dispatchEvent(new Event('change'));
});

function getVideoDuration(videoPath){
  return new Promise((resolve, reject) => {
    var video = document.createElement('video');
    video.preload = 'metadata';
    video.onloadedmetadata = function(){
      var duration = video.duration;
      var xhr = new XMLHttpRequest();
      xhr.open('HEAD', videoPath, true);
      xhr.onreadystatechange = function(){
        if (xhr.readyState === 4){
          resolve({ duration });
        }
      };
      xhr.send();
    };
    video.onerror = function(){
      reject('Error to loading video');
    };
    video.src = videoPath;
  });
}
function displayVinfo(path){
  getVideoDuration(path).then(info => {
    console.log(`Duration: ${Math.round(info.duration)}seconds`);
  }).catch(error => {
    console.error(error);
  });
}
let Filevalidation = (max, min) => {
  const fi = document.getElementById('file-input');
  if(fi.files.length > 0){
    for(let i = 0; i <= fi.files.length - 1; i++){
      const fsize = fi.files.item(i).size;
      const file = Math.round((fsize / 1024));
      if(file >= max){
        alert("File too Big, please select a file less than 4mb");
      }else if(file < min){
        alert("File too small, please select a file greater than 2mb");
      }else{
        console.log(file + " Kb");
      }
    }
  }
}